# InternNav VLN系统优化方案

## 1. 问题分析

### 1.1 当前系统瓶颈
**Token生成效率问题**
- 设定max_new_tokens=128作为生成上限
- 实际观测输出：动作序列2-8个token，坐标固定8个token  
- 虽然有early stopping，但仍存在推理过程中的计算冗余
- 无法提前预知输出类型进行针对性优化

**视觉编码固定策略**
- 所有场景使用相同的视觉token压缩率
- 未根据任务阶段和输出需求进行自适应调整
- 计算资源分配不够精准

## 2. 解决方案架构

### 2.1 Speculative Decoding优化
**核心思想**: 提前预测输出类型，动态调整生成策略

**实现机制**:
- 训练轻量级draft model预测输出模式
- 根据预测结果设置不同的max_tokens
- 实现格式检测的early stopping机制

### 2.2 自适应视觉Token压缩
**核心假设**: 不同输出类型反映不同的导航认知阶段

**任务阶段理论**:
- **探索阶段** → 输出动作序列 → 粗粒度语义理解为主
- **精确阶段** → 输出视觉坐标 → 像素级精度定位为主

## 3. 技术实现机制

### 3.1 阶段感知的压缩策略

#### 精确定位模式 (坐标输出)
**适用场景**: System2输出"160 221"类坐标
**压缩配置**:
```
- 全局context: 保留70% (需要场景理解)
- 局部细节: 保留90% (pixel-level精度)  
- ROI区域: 保留100% (目标区域完整)
```
**设计依据**: 坐标输出代表agent已进入精确定位阶段，需要高精度视觉信息支持像素级操作

#### 探索导航模式 (动作输出)  
**适用场景**: System2输出"←←←→"类符号
**压缩配置**:
```
- 全局context: 保留30% (基础空间理解)
- 局部细节: 保留50% (减少冗余信息)
- 语义特征: 重点保留 (高级认知需求)
```
**设计依据**: 动作输出代表粗粒度导航决策，更依赖语义理解而非像素精度

### 3.2 距离感知剪枝机制
**空间注意力分配**:
- **近距离区域** (<2m): 保留90% token
  - 直接影响下一步action选择
  - 需要精确的障碍物和地形信息
  
- **中距离区域** (2-5m): 保留60% token  
  - 提供中期路径规划参考
  - 平衡精度与效率
  
- **远距离区域** (>5m): 保留30% token
  - 仅提供全局上下文信息
  - 大幅减少计算负担

### 3.3 动态预测机制
**两阶段预测流程**:
1. **Stage 1**: 轻量级分类器预测输出类型
   - 输入: 当前观察 + 指令embedding
   - 输出: binary_classification (action_type | coordinate_type)
   
2. **Stage 2**: 基于预测结果进行自适应编码
   - 动态调整视觉token压缩率
   - 设置相应的generation parameters

## 4. 预期性能收益

### 4.1 计算加速分析
**Speculative Decoding收益**:
- 提前预测输出类型，减少推理不确定性
- 动作序列模式: 可针对性设置较小生成窗口
- 坐标模式: 精确控制8-token格式生成
- 预期加速: 2-4倍（通过减少推理计算和更精准的stopping）

**视觉压缩收益**:
- 探索模式: 70%计算量减少 → 3.3倍加速
- 距离剪枝: 40-60%token减少 → 1.7-2.5倍加速
- 组合效果: 2-4倍视觉编码加速

### 4.2 整体系统提升
**保守估计**: 3-5倍整体加速
**理想情况**: 5-8倍整体加速  
**精度保持**: 精确模式下accuracy基本无损

## 5. 方案优势

### 5.1 认知科学依据
- 符合人类视觉注意力的空间分配规律
- 体现了任务导向的资源配置原则
- 实现了粗细粒度导航的有机结合

### 5.2 工程实现优势  
- 模块化设计，易于集成到现有系统
- 可以渐进式部署和优化
- 对现有模型架构侵入性较小
